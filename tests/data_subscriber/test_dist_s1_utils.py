#!/usr/bin/env python3
import datetime

import pytest
import conftest
import pickle
from data_subscriber.dist_s1_utils import localize_dist_burst_db, compute_dist_s1_triggering, build_rtc_native_ids, parse_k_parameter
from data_subscriber.dist_s1_utils import previous_product_download_batch_id_from_rtc, previous_product_download_batch_id

_GRANULES_FOR_CACHE_TEST=["OPERA_L2_RTC-S1_T071-151232-IW2_20250602T135301Z_20250606T052107Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151229-IW3_20250602T135254Z_20250606T052107Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151229-IW2_20250602T135253Z_20250606T052107Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T064-135517-IW1_20250602T015034Z_20250605T081957Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292314-IW2_20250607T015844Z_20250614T012824Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292312-IW2_20250607T015838Z_20250614T012824Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151233-IW2_20250614T135303Z_20250623T041828Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151228-IW2_20250614T135250Z_20250623T041828Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151227-IW2_20250614T135247Z_20250623T041828Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T064-135520-IW1_20250614T015042Z_20250622T152306Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T144-308027-IW1_20250619T140103Z_20250628T201817Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292317-IW2_20250619T015851Z_20250628T083137Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292316-IW2_20250619T015848Z_20250628T083137Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151231-IW2_20250602T135259Z_20250606T052107Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151227-IW3_20250602T135248Z_20250606T052107Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T064-135521-IW1_20250602T015045Z_20250605T081946Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T064-135520-IW1_20250602T015042Z_20250605T081946Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T064-135519-IW1_20250602T015040Z_20250605T081946Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T144-308031-IW1_20250607T140114Z_20250614T191851Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292313-IW3_20250607T015842Z_20250614T012824Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151228-IW3_20250614T135250Z_20250623T041828Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T064-135517-IW1_20250614T015033Z_20250622T142942Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292315-IW2_20250619T015846Z_20250628T083137Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292312-IW2_20250619T015837Z_20250628T083147Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292311-IW3_20250619T015835Z_20250628T083147Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151230-IW2_20250602T135256Z_20250606T052107Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T064-135518-IW1_20250602T015037Z_20250605T081946Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T064-135515-IW1_20250602T015029Z_20250605T081957Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T144-308029-IW1_20250607T140109Z_20250614T191851Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292317-IW2_20250607T015852Z_20250614T012801Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292312-IW3_20250607T015839Z_20250614T012824Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151232-IW3_20250614T135302Z_20250623T041828Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T144-308031-IW1_20250619T140114Z_20250628T201813Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292318-IW2_20250619T015854Z_20250628T083137Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151232-IW3_20250602T135302Z_20250606T052107Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151228-IW3_20250602T135251Z_20250606T052107Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151227-IW2_20250602T135248Z_20250606T052107Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T064-135516-IW1_20250602T015031Z_20250605T081957Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T144-308030-IW1_20250607T140112Z_20250614T191851Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T144-308026-IW1_20250607T140101Z_20250614T191912Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292316-IW2_20250607T015849Z_20250614T012801Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151230-IW3_20250614T135256Z_20250623T041828Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151229-IW2_20250614T135252Z_20250623T041828Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151226-IW3_20250614T135245Z_20250623T041828Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T064-135521-IW1_20250614T015044Z_20250622T152306Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292318-IW3_20250619T015855Z_20250628T083137Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151230-IW3_20250602T135257Z_20250606T052107Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292313-IW2_20250607T015841Z_20250614T012824Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151231-IW3_20250614T135259Z_20250623T041828Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151227-IW3_20250614T135248Z_20250623T041828Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T144-308026-IW1_20250619T140100Z_20250628T201817Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292315-IW3_20250619T015847Z_20250628T083137Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292314-IW3_20250619T015844Z_20250628T083147Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292314-IW2_20250619T015843Z_20250628T083147Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292312-IW3_20250619T015838Z_20250628T083147Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151233-IW3_20250602T135305Z_20250606T052107Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151231-IW3_20250602T135259Z_20250606T052107Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151226-IW3_20250602T135246Z_20250606T052107Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T144-308027-IW1_20250607T140103Z_20250614T191912Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292317-IW3_20250607T015853Z_20250614T012801Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292316-IW3_20250607T015850Z_20250614T012801Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292315-IW3_20250607T015847Z_20250614T012801Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292314-IW3_20250607T015844Z_20250614T012824Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151229-IW3_20250614T135253Z_20250623T041828Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T064-135519-IW1_20250614T015039Z_20250622T152306Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T064-135515-IW1_20250614T015028Z_20250622T142942Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151233-IW2_20250602T135304Z_20250606T052107Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151228-IW2_20250602T135250Z_20250606T052107Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292318-IW3_20250607T015855Z_20250614T012801Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292318-IW2_20250607T015855Z_20250614T012801Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292315-IW2_20250607T015846Z_20250614T012801Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151233-IW3_20250614T135304Z_20250623T041828Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151230-IW2_20250614T135255Z_20250623T041828Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T064-135518-IW1_20250614T015036Z_20250622T152306Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T064-135516-IW1_20250614T015031Z_20250622T142942Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T144-308030-IW1_20250619T140111Z_20250628T201813Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292316-IW3_20250619T015849Z_20250628T083137Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292313-IW3_20250619T015841Z_20250628T083147Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292311-IW3_20250607T015836Z_20250614T012824Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151232-IW2_20250614T135301Z_20250623T041828Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151231-IW2_20250614T135258Z_20250623T041828Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T144-308029-IW1_20250619T140108Z_20250628T201813Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292317-IW3_20250619T015852Z_20250628T083137Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T137-292313-IW2_20250619T015840Z_20250628T083147Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T064-135520-IW2_20250602T015043Z_20250605T081946Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T144-308028-IW1_20250607T140106Z_20250614T191851Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T064-135520-IW2_20250614T015042Z_20250622T152306Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T144-308028-IW1_20250619T140105Z_20250628T201813Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151226-IW2_20250602T135245Z_20250606T011959Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T144-308025-IW1_20250607T140058Z_20250614T191912Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T071-151226-IW2_20250614T135244Z_20250623T041851Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T144-308025-IW1_20250619T140057Z_20250628T201817Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T144-308024-IW1_20250607T140055Z_20250614T191912Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T144-308024-IW1_20250619T140054Z_20250628T201817Z_S1A_30_v1.0"]
_GRANULES_FOR_CACHE_TEST_35XMK=["OPERA_L2_RTC-S1_T154-329223-IW1_20250608T061528Z_20250615T232952Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T174-372076-IW3_20250609T150530Z_20250618T002035Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T154-329223-IW1_20250620T061527Z_20250629T122948Z_S1A_30_v1.0", "OPERA_L2_RTC-S1_T174-372076-IW3_20250621T150529Z_20250630T211717Z_S1A_30_v1.0"]
_DENORM_GRANULES = [('OPERA_L2_RTC-S1_T025-052667-IW2_20240312T102159Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T025-052666-IW2_20240312T102156Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T025-052666-IW1_20240312T102155Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T025-052665-IW2_20240312T102154Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T025-052665-IW1_20240312T102153Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T025-052664-IW2_20240312T102151Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T025-052664-IW1_20240312T102150Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T025-052663-IW2_20240312T102148Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T025-052663-IW1_20240312T102147Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T025-052662-IW3_20240312T102146Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T025-052662-IW2_20240312T102145Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T025-052662-IW1_20240312T102144Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T025-052661-IW3_20240312T102143Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T025-052661-IW1_20240312T102142Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T025-052661-IW2_20240312T102142Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T025-052660-IW3_20240312T102141Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T025-052660-IW2_20240312T102140Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T025-052660-IW1_20240312T102139Z', '19MCP_0_310'), ('OPERA_L2_RTC-S1_T168-359426-IW2_20231217T052407Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359429-IW3_20231217T052416Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359423-IW3_20231217T052359Z', '32VPM_6_302'), ('OPERA_L2_RTC-S1_T168-359422-IW3_20231217T052356Z', '33VVG_5_302'), ('OPERA_L2_RTC-S1_T168-359422-IW3_20231217T052356Z', '32VPM_6_302'), ('OPERA_L2_RTC-S1_T168-359428-IW1_20231217T052411Z', '33VWF_4_302'), ('OPERA_L2_RTC-S1_T168-359427-IW2_20231217T052409Z', '33VWF_4_302'), ('OPERA_L2_RTC-S1_T168-359425-IW2_20231217T052404Z', '33VWF_4_302'), ('OPERA_L2_RTC-S1_T168-359445-IW3_20231217T052500Z', '32VPH_6_302'), ('OPERA_L2_RTC-S1_T168-359444-IW3_20231217T052457Z', '33VUC_5_302'), ('OPERA_L2_RTC-S1_T168-359423-IW1_20231217T052357Z', '33VWG_5_302'), ('OPERA_L2_RTC-S1_T168-359429-IW1_20231217T052414Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359427-IW1_20231217T052408Z', '33VWF_4_302'), ('OPERA_L2_RTC-S1_T168-359445-IW1_20231217T052458Z', '33UWB_4_302'), ('OPERA_L2_RTC-S1_T168-359444-IW2_20231217T052456Z', '33VUC_5_302'), ('OPERA_L2_RTC-S1_T168-359440-IW2_20231217T052445Z', '33VUC_5_302'), ('OPERA_L2_RTC-S1_T168-359427-IW1_20231217T052408Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359423-IW3_20231217T052359Z', '33VUF_5_302'), ('OPERA_L2_RTC-S1_T168-359423-IW1_20231217T052357Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359427-IW3_20231217T052410Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359426-IW3_20231217T052408Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359425-IW1_20231217T052403Z', '33VWF_4_302'), ('OPERA_L2_RTC-S1_T168-359444-IW3_20231217T052457Z', '32VPH_6_302'), ('OPERA_L2_RTC-S1_T168-359443-IW3_20231217T052454Z', '32VPH_6_302'), ('OPERA_L2_RTC-S1_T168-359440-IW3_20231217T052446Z', '32VPH_6_302'), ('OPERA_L2_RTC-S1_T168-359441-IW3_20231217T052449Z', '33VUC_5_302'), ('OPERA_L2_RTC-S1_T168-359441-IW2_20231217T052448Z', '33VUC_5_302'), ('OPERA_L2_RTC-S1_T168-359444-IW2_20231217T052456Z', '33UUB_5_302'), ('OPERA_L2_RTC-S1_T168-359443-IW3_20231217T052454Z', '33VUC_5_302'), ('OPERA_L2_RTC-S1_T168-359428-IW2_20231217T052412Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359424-IW3_20231217T052402Z', '33VVG_5_302'), ('OPERA_L2_RTC-S1_T168-359424-IW3_20231217T052402Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359425-IW1_20231217T052403Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359423-IW3_20231217T052359Z', '33VVG_5_302'), ('OPERA_L2_RTC-S1_T168-359424-IW1_20231217T052400Z', '33VWF_4_302'), ('OPERA_L2_RTC-S1_T168-359423-IW3_20231217T052359Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359442-IW3_20231217T052452Z', '33VUC_5_302'), ('OPERA_L2_RTC-S1_T168-359445-IW3_20231217T052500Z', '32UPG_5_302'), ('OPERA_L2_RTC-S1_T168-359445-IW3_20231217T052500Z', '33UUB_5_302'), ('OPERA_L2_RTC-S1_T168-359444-IW1_20231217T052455Z', '33UVB_4_302'), ('OPERA_L2_RTC-S1_T168-359442-IW3_20231217T052452Z', '32VPH_6_302'), ('OPERA_L2_RTC-S1_T168-359425-IW3_20231217T052405Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359424-IW2_20231217T052401Z', '33VVG_5_302'), ('OPERA_L2_RTC-S1_T168-359423-IW3_20231217T052359Z', '33VUG_5_302'), ('OPERA_L2_RTC-S1_T168-359423-IW2_20231217T052358Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359423-IW2_20231217T052358Z', '33VWG_5_302'), ('OPERA_L2_RTC-S1_T168-359439-IW3_20231217T052443Z', '33VUC_5_302'), ('OPERA_L2_RTC-S1_T168-359445-IW2_20231217T052459Z', '33UVB_4_302'), ('OPERA_L2_RTC-S1_T168-359424-IW2_20231217T052401Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359424-IW1_20231217T052400Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359428-IW1_20231217T052411Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359426-IW2_20231217T052407Z', '33VWF_4_302'), ('OPERA_L2_RTC-S1_T168-359423-IW2_20231217T052358Z', '33VWF_4_302'), ('OPERA_L2_RTC-S1_T168-359442-IW2_20231217T052451Z', '33VUC_5_302'), ('OPERA_L2_RTC-S1_T168-359440-IW3_20231217T052446Z', '33VUC_5_302'), ('OPERA_L2_RTC-S1_T168-359445-IW3_20231217T052500Z', '33VUC_5_302'), ('OPERA_L2_RTC-S1_T168-359425-IW2_20231217T052404Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359429-IW2_20231217T052415Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359426-IW1_20231217T052406Z', '33VWF_4_302'), ('OPERA_L2_RTC-S1_T168-359424-IW2_20231217T052401Z', '33VWF_4_302'), ('OPERA_L2_RTC-S1_T168-359423-IW2_20231217T052358Z', '33VVG_5_302'), ('OPERA_L2_RTC-S1_T168-359423-IW1_20231217T052357Z', '33VWF_4_302'), ('OPERA_L2_RTC-S1_T168-359439-IW2_20231217T052442Z', '33VUC_5_302'), ('OPERA_L2_RTC-S1_T168-359445-IW2_20231217T052459Z', '33VUC_5_302'), ('OPERA_L2_RTC-S1_T168-359444-IW2_20231217T052456Z', '33UVB_4_302'), ('OPERA_L2_RTC-S1_T168-359445-IW2_20231217T052459Z', '33UUB_5_302'), ('OPERA_L2_RTC-S1_T168-359443-IW2_20231217T052453Z', '33VUC_5_302'), ('OPERA_L2_RTC-S1_T168-359426-IW1_20231217T052406Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359424-IW3_20231217T052402Z', '33VUG_5_302'), ('OPERA_L2_RTC-S1_T168-359422-IW3_20231217T052356Z', '33VUG_5_302'), ('OPERA_L2_RTC-S1_T168-359445-IW1_20231217T052458Z', '33UVB_4_302'), ('OPERA_L2_RTC-S1_T168-359444-IW1_20231217T052455Z', '33UWB_4_302'), ('OPERA_L2_RTC-S1_T168-359441-IW3_20231217T052449Z', '32VPH_6_302'), ('OPERA_L2_RTC-S1_T168-359429-IW1_20231217T052414Z', '33VWF_4_302'), ('OPERA_L2_RTC-S1_T168-359428-IW3_20231217T052413Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359427-IW2_20231217T052409Z', '33VVF_4_302'), ('OPERA_L2_RTC-S1_T168-359424-IW3_20231217T052402Z', '32VPM_6_302')]
_GRANULES_DICT = {}
for key in _DENORM_GRANULES:
    _GRANULES_DICT[key] = {"creation_timestamp": '2025-01-01T01:00:00.000000'}

dist_products, bursts_to_products, product_to_bursts, all_tile_ids = localize_dist_burst_db()

def test_burst_map_pickle():
    '''Test that we can pickle and unpickle burst map files'''

    dist_products, bursts_to_products, product_to_bursts, all_tile_ids = localize_dist_burst_db()

    # Save the lengths of all the objects for comparison after unpickling
    dist_products_len = len(dist_products)
    bursts_to_products_len = len(bursts_to_products)
    product_to_bursts_len = len(product_to_bursts)
    all_tile_ids_len = len(all_tile_ids)

    # First, pickle dist_products, bursts_to_products, product_to_bursts, all_tile_ids into a single file
    with open("dist_products.pickle", "wb") as f:
        pickle.dump((dist_products, bursts_to_products, product_to_bursts, all_tile_ids), f)

    # Now, unpickle the file
    with open("dist_products.pickle", "rb") as f:
        dist_products, bursts_to_products, product_to_bursts, all_tile_ids = pickle.load(f)

    # Check that the lengths of the unpickled objects are the same as the original ones
    assert len(dist_products) == dist_products_len
    assert len(bursts_to_products) == bursts_to_products_len
    assert len(product_to_bursts) == product_to_bursts_len
    assert len(all_tile_ids) == all_tile_ids_len

def test_compute_dist_s1_triggering_incomplete():
    """Given a list of granules, test that we are extending additional granules for bursts that belong to two frames"""

    products_triggered, granules_triggered, _, _ = (
        compute_dist_s1_triggering(product_to_bursts, _GRANULES_DICT, True, 50, datetime.datetime(2025, 1, 1, 2, 0, 0)))

    assert len(products_triggered) == 14
    print(products_triggered)

    assert len(products_triggered["19MCP_0_310"].rtc_granules) == 18
    assert len(products_triggered["33VVF_4_302"].rtc_granules) == 21
    assert len(products_triggered["33VUC_5_302"].rtc_granules) == 14
    assert len(products_triggered["33UUB_5_302"].rtc_granules) == 3
    assert len(products_triggered["33VWF_4_302"].rtc_granules) == 12


def test_compute_dist_s1_triggering_complete():
    """Given a list of granules, test that we are extending additional granules for bursts that belong to two frames"""

    products_triggered, granules_triggered, _, _ = (
        compute_dist_s1_triggering(product_to_bursts, _GRANULES_DICT, True, 210, datetime.datetime(2025, 1, 1, 2, 0, 0)))

    assert len(products_triggered) == 1

    assert len(products_triggered["19MCP_0_310"].rtc_granules) == 18

def test_build_rtc_native_ids():
    '''Test building up rtc native ids'''
    l, native_id = build_rtc_native_ids("32RLV_3", product_to_bursts)
    #print("----------------------------------")
    assert l == 16
    assert native_id == \
           "OPERA_L2_RTC-S1_T168-359591-IW1*&native-id[]=OPERA_L2_RTC-S1_T168-359591-IW2*&native-id[]=OPERA_L2_RTC-S1_T168-359592-IW1*&native-id[]=OPERA_L2_RTC-S1_T168-359592-IW2*&native-id[]=OPERA_L2_RTC-S1_T168-359593-IW1*&native-id[]=OPERA_L2_RTC-S1_T168-359593-IW2*&native-id[]=OPERA_L2_RTC-S1_T168-359594-IW1*&native-id[]=OPERA_L2_RTC-S1_T168-359594-IW2*&native-id[]=OPERA_L2_RTC-S1_T168-359595-IW1*&native-id[]=OPERA_L2_RTC-S1_T168-359595-IW2*&native-id[]=OPERA_L2_RTC-S1_T168-359596-IW1*&native-id[]=OPERA_L2_RTC-S1_T168-359596-IW2*&native-id[]=OPERA_L2_RTC-S1_T168-359597-IW1*&native-id[]=OPERA_L2_RTC-S1_T168-359597-IW2*&native-id[]=OPERA_L2_RTC-S1_T168-359598-IW1*&native-id[]=OPERA_L2_RTC-S1_T168-359598-IW2*"

def test_parse_k_parameter():
    assert parse_k_parameter("[(365, 3), (730, 3), (1095, 3)]") == [(365, 3), (730, 3), (1095, 3)]
    
def test_previous_product_download_batch_id():
    assert "p11SLT_2_a348" == previous_product_download_batch_id(dist_products, "p11SLT_3_a348")
    assert "p11SLT_3_a347" == previous_product_download_batch_id(dist_products, "p11SLT_0_a348")
    assert "p35XMK_22_a347" == previous_product_download_batch_id(dist_products, "p35XMK_0_a348")

def test_previous_product_download_batch_id_from_rtc():
    '''Test that we can determine the previous product download batch id from a list of RTC granules'''
    assert "p11SLT_3_a347" == previous_product_download_batch_id_from_rtc(dist_products, bursts_to_products, "p11SLT_0_a348", _GRANULES_FOR_CACHE_TEST)
    assert "p11SLT_1_a348" == previous_product_download_batch_id_from_rtc(dist_products, bursts_to_products, "p11SLT_2_a348", _GRANULES_FOR_CACHE_TEST)
    assert "p11SLT_2_a348" == previous_product_download_batch_id_from_rtc(dist_products, bursts_to_products, "p11SLT_3_a348", _GRANULES_FOR_CACHE_TEST)

    assert "p35XMK_19_a348" == previous_product_download_batch_id_from_rtc(dist_products, bursts_to_products, "p35XMK_22_a348", _GRANULES_FOR_CACHE_TEST_35XMK)
    assert "p35XMK_22_a347" == previous_product_download_batch_id_from_rtc(dist_products, bursts_to_products, "p35XMK_19_a348", _GRANULES_FOR_CACHE_TEST_35XMK)
    assert "p35XMK_19_a347" == previous_product_download_batch_id_from_rtc(dist_products, bursts_to_products, "p35XMK_22_a347", _GRANULES_FOR_CACHE_TEST_35XMK)
    assert None             == previous_product_download_batch_id_from_rtc(dist_products, bursts_to_products, "p35XMK_19_a347", _GRANULES_FOR_CACHE_TEST_35XMK)
